<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¬Ø§Ù…Ø¹ØªÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    colors: { dark: { bg: '#0f172a', card: '#1e293b', border: '#334155', text: '#f8fafc', muted: '#94a3b8' } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; transition: background-color 0.3s; }
        .spinner { width: 30px; height: 30px; border: 3px solid #e2e8f0; border-top: 3px solid #4f46e5; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-dark-bg dark:text-dark-text">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmCmcR6OIQ00tQrmaTTnoe4kU6L4fQZ00",
            authDomain: "myeduplatform-fe0eb.firebaseapp.com",
            projectId: "myeduplatform-fe0eb",
            storageBucket: "myeduplatform-fe0eb.firebasestorage.app",
            messagingSenderId: "773570577444",
            appId: "1:773570577444:web:c94cc1c8267ecbadd004b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.fb = { auth, db, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, orderBy };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Ù…ÙƒÙˆÙ‘Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Toast) ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
            return (
                <div className={`fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-2xl shadow-xl flex items-center gap-3 animate-bounce ${type === 'error' ? 'bg-red-600' : 'bg-emerald-600'} text-white`}>
                    <i data-lucide={type === 'error' ? 'alert-circle' : 'check-circle'} className="w-5 h-5"></i>
                    <span className="font-bold text-sm">{message}</span>
                </div>
            );
        };

        // --- Ù…ÙƒÙˆÙ‘Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ© ---
        const EmptyState = ({ icon, title }) => (
            <div className="text-center py-10 opacity-50">
                <i data-lucide={icon} className="w-12 h-12 mx-auto mb-2 text-slate-400"></i>
                <p className="font-bold">{title}</p>
            </div>
        );

        // --- App Component ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [ready, setReady] = useState(false);
            const [toast, setToast] = useState(null);

            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => window.lucide.createIcons(), 10); };

            useEffect(() => {
                const init = () => { if (window.fb) { setReady(true); window.fb.onAuthStateChanged(window.fb.auth, setUser); } };
                if (window.fb) init(); else window.addEventListener('firebase-ready', init);
            }, []);

            if (!ready) return <div className="min-h-screen flex items-center justify-center"><div className="spinner"></div></div>;

            return (
                <div>
                    {user ? <Dashboard user={user} showToast={showToast} /> : <AuthScreen showToast={showToast} />}
                    {toast && <Toast {...toast} onClose={() => setToast(null)} />}
                </div>
            );
        };

        // --- Dashboard ---
        const Dashboard = ({ user, showToast }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');

            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
                localStorage.setItem('theme', darkMode ? 'dark' : 'light');
            }, [darkMode]);

            useEffect(() => { window.lucide.createIcons(); }, [activeTab]);

            const NavItem = ({ id, icon, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col md:flex-row items-center gap-2 px-4 py-2 rounded-xl transition-all ${activeTab === id ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800'}`}>
                    <i data-lucide={icon} className="w-5 h-5"></i>
                    <span className="text-[10px] md:text-sm font-bold">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-slate-50 dark:bg-dark-bg transition-colors duration-300">
                    <aside className="hidden md:flex flex-col w-64 bg-white dark:bg-dark-card p-6 sticky top-0 h-screen border-l dark:border-dark-border">
                        <div className="flex items-center gap-3 mb-10"><i data-lucide="graduation-cap" className="text-indigo-600"></i><h1 className="font-black text-xl dark:text-white">Ø¬Ø§Ù…Ø¹ØªÙŠ</h1></div>
                        <nav className="flex-1 space-y-2">
                            <NavItem id="home" icon="home" label="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" />
                            <NavItem id="courses" icon="book" label="Ø§Ù„Ù…ÙˆØ§Ø¯" />
                            <NavItem id="exams" icon="calendar" label="Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª" />
                            <NavItem id="tasks" icon="check-square" label="Ø§Ù„Ù…Ù‡Ø§Ù…" />
                        </nav>
                        <button onClick={() => setDarkMode(!darkMode)} className="p-3 bg-slate-100 dark:bg-dark-bg rounded-xl font-bold text-xs flex justify-center gap-2">
                            <i data-lucide={darkMode ? "sun" : "moon"} className="w-4 h-4"></i> {darkMode ? "Ù†Ù‡Ø§Ø±ÙŠ" : "Ù„ÙŠÙ„ÙŠ"}
                        </button>
                        <button onClick={() => window.fb.signOut(window.fb.auth)} className="mt-2 p-3 text-red-500 font-bold text-xs flex justify-center gap-2">
                            <i data-lucide="log-out" className="w-4 h-4"></i> Ø®Ø±ÙˆØ¬
                        </button>
                    </aside>

                    <main className="flex-1 p-4 md:p-8 pb-24 md:pb-8 overflow-y-auto">
                        <div className="max-w-4xl mx-auto">
                            {activeTab === 'home' && <HomeView user={user} setTab={setActiveTab} />}
                            {activeTab === 'courses' && <CoursesView user={user} showToast={showToast} />}
                            {activeTab === 'exams' && <ExamsView user={user} showToast={showToast} />}
                            {activeTab === 'tasks' && <TasksView user={user} showToast={showToast} />}
                        </div>
                    </main>

                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card border-t dark:border-dark-border p-2 flex justify-around z-50">
                        <NavItem id="home" icon="home" label="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" />
                        <NavItem id="courses" icon="book" label="Ø§Ù„Ù…ÙˆØ§Ø¯" />
                        <NavItem id="exams" icon="calendar" label="Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª" />
                        <NavItem id="tasks" icon="check-square" label="Ø§Ù„Ù…Ù‡Ø§Ù…" />
                    </nav>
                </div>
            );
        };

        // --- 1. Home View ---
        const HomeView = ({ user, setTab }) => {
            const [stats, setStats] = useState({ courses: 0, exams: 0, tasks: 0 });

            useEffect(() => {
                const qC = window.fb.query(window.fb.collection(window.fb.db, "courses"), window.fb.where("uid", "==", user.uid));
                const qE = window.fb.query(window.fb.collection(window.fb.db, "exams"), window.fb.where("uid", "==", user.uid));
                const qT = window.fb.query(window.fb.collection(window.fb.db, "tasks"), window.fb.where("uid", "==", user.uid), window.fb.where("completed", "==", false));
                
                const unsubC = window.fb.onSnapshot(qC, s => setStats(p => ({...p, courses: s.size})));
                const unsubE = window.fb.onSnapshot(qE, s => setStats(p => ({...p, exams: s.size})));
                const unsubT = window.fb.onSnapshot(qT, s => setStats(p => ({...p, tasks: s.size})));
                return () => { unsubC(); unsubE(); unsubT(); };
            }, [user]);

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-700 p-8 rounded-[2rem] text-white shadow-xl">
                        <h2 className="text-3xl font-black mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„! ğŸš€</h2>
                        <p className="opacity-80">Ù„Ø¯ÙŠÙƒ {stats.tasks} Ù…Ù‡Ø§Ù… Ù…Ø¹Ù„Ù‚Ø© Ø§Ù„ÙŠÙˆÙ….</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <StatCard icon="book" val={stats.courses} label="Ù…ÙˆØ§Ø¯" color="blue" onClick={() => setTab('courses')} />
                        <StatCard icon="calendar" val={stats.exams} label="Ø§Ù…ØªØ­Ø§Ù†Ø§Øª" color="red" onClick={() => setTab('exams')} />
                        <StatCard icon="check-square" val={stats.tasks} label="Ù…Ù‡Ø§Ù…" color="orange" onClick={() => setTab('tasks')} />
                    </div>
                </div>
            );
        };

        const StatCard = ({ icon, val, label, color, onClick }) => (
            <div onClick={onClick} className="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border-b-4 cursor-pointer active:scale-95 transition" style={{ borderColor: color }}>
                <i data-lucide={icon} style={{ color: color }} className="mb-2"></i>
                <div className="text-2xl font-black dark:text-white">{val}</div>
                <div className="text-xs font-bold text-slate-500 uppercase">{label}</div>
            </div>
        );

        // --- 2. Courses View ---
        const CoursesView = ({ user, showToast }) => {
            const [courses, setCourses] = useState([]);
            const [name, setName] = useState('');

            useEffect(() => {
                const q = window.fb.query(window.fb.collection(window.fb.db, "courses"), window.fb.where("uid", "==", user.uid));
                return window.fb.onSnapshot(q, s => { setCourses(s.docs.map(d => ({id: d.id, ...d.data()}))); setTimeout(() => window.lucide.createIcons(), 50); });
            }, [user]);

            const add = async (e) => {
                e.preventDefault(); if (!name.trim()) return;
                await window.fb.addDoc(window.fb.collection(window.fb.db, "courses"), { uid: user.uid, name, absences: 0 });
                setName(''); showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-black dark:text-white">Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
                    <form onSubmit={add} className="flex gap-2"><input value={name} onChange={e=>setName(e.target.value)} placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©..." className="flex-1 p-3 rounded-xl bg-white dark:bg-dark-card border-none outline-none dark:text-white shadow-sm" /><button className="bg-indigo-600 text-white px-6 rounded-xl font-bold">Ø¥Ø¶Ø§ÙØ©</button></form>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {courses.length === 0 ? <EmptyState icon="book-x" title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯" /> : courses.map(c => (
                            <div key={c.id} className="bg-white dark:bg-dark-card p-5 rounded-2xl shadow-sm">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold dark:text-white">{c.name}</h3><button onClick={() => window.fb.deleteDoc(window.fb.doc(window.fb.db, "courses", c.id))} className="text-red-400"><i data-lucide="trash-2" className="w-4 h-4"></i></button></div>
                                <div className="flex justify-between items-center bg-slate-50 dark:bg-dark-bg p-2 rounded-xl">
                                    <span className="text-xs font-bold">Ø§Ù„ØºÙŠØ§Ø¨: {c.absences}</span>
                                    <div className="flex gap-1"><button onClick={() => window.fb.updateDoc(window.fb.doc(window.fb.db, "courses", c.id), { absences: Math.max(0, c.absences - 1) })} className="w-8 h-8 bg-white dark:bg-dark-card rounded-lg flex items-center justify-center">-</button><button onClick={() => window.fb.updateDoc(window.fb.doc(window.fb.db, "courses", c.id), { absences: c.absences + 1 })} className="w-8 h-8 bg-indigo-600 text-white rounded-lg flex items-center justify-center">+</button></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 3. Exams View (NOW WORKING) ---
        const ExamsView = ({ user, showToast }) => {
            const [exams, setExams] = useState([]);
            const [form, setForm] = useState({ subject: '', date: '' });

            useEffect(() => {
                const q = window.fb.query(window.fb.collection(window.fb.db, "exams"), window.fb.where("uid", "==", user.uid), window.fb.orderBy("date", "asc"));
                return window.fb.onSnapshot(q, s => { setExams(s.docs.map(d => ({id: d.id, ...d.data()}))); setTimeout(() => window.lucide.createIcons(), 50); });
            }, [user]);

            const add = async (e) => {
                e.preventDefault(); if (!form.subject || !form.date) return;
                await window.fb.addDoc(window.fb.collection(window.fb.db, "exams"), { uid: user.uid, ...form });
                setForm({ subject: '', date: '' }); showToast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†");
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-black dark:text-white">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
                    <form onSubmit={add} className="bg-white dark:bg-dark-card p-4 rounded-2xl shadow-sm grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input value={form.subject} onChange={e=>setForm({...form, subject:e.target.value})} placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" className="p-2 rounded-lg bg-slate-50 dark:bg-dark-bg border-none dark:text-white" />
                        <input type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} className="p-2 rounded-lg bg-slate-50 dark:bg-dark-bg border-none dark:text-white" />
                        <button className="bg-red-600 text-white font-bold rounded-lg p-2">Ø­ÙØ¸</button>
                    </form>
                    <div className="space-y-3">
                        {exams.length === 0 ? <EmptyState icon="calendar-x" title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª" /> : exams.map(ex => {
                            const diff = Math.ceil((new Date(ex.date) - new Date()) / (1000 * 60 * 60 * 24));
                            return (
                                <div key={ex.id} className="bg-white dark:bg-dark-card p-4 rounded-2xl flex justify-between items-center shadow-sm">
                                    <div><h3 className="font-bold dark:text-white">{ex.subject}</h3><p className="text-xs text-slate-500">{ex.date}</p></div>
                                    <div className="flex items-center gap-4">
                                        <div className={`px-3 py-1 rounded-full text-xs font-bold ${diff < 3 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>Ù…ØªØ¨Ù‚ÙŠ {diff} ÙŠÙˆÙ…</div>
                                        <button onClick={() => window.fb.deleteDoc(window.fb.doc(window.fb.db, "exams", ex.id))} className="text-slate-300"><i data-lucide="x-circle" className="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- 4. Tasks View (NOW WORKING) ---
        const TasksView = ({ user, showToast }) => {
            const [tasks, setTasks] = useState([]);
            const [title, setTitle] = useState('');

            useEffect(() => {
                const q = window.fb.query(window.fb.collection(window.fb.db, "tasks"), window.fb.where("uid", "==", user.uid));
                return window.fb.onSnapshot(q, s => { setTasks(s.docs.map(d => ({id: d.id, ...d.data()}))); setTimeout(() => window.lucide.createIcons(), 50); });
            }, [user]);

            const add = async (e) => {
                e.preventDefault(); if (!title.trim()) return;
                await window.fb.addDoc(window.fb.collection(window.fb.db, "tasks"), { uid: user.uid, title, completed: false });
                setTitle(''); showToast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©");
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-black dark:text-white">Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
                    <form onSubmit={add} className="flex gap-2"><input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..." className="flex-1 p-3 rounded-xl bg-white dark:bg-dark-card border-none outline-none dark:text-white shadow-sm" /><button className="bg-emerald-600 text-white px-6 rounded-xl font-bold">+</button></form>
                    <div className="space-y-2">
                        {tasks.length === 0 ? <EmptyState icon="clipboard-list" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©" /> : tasks.map(t => (
                            <div key={t.id} className={`flex items-center gap-3 p-4 rounded-xl bg-white dark:bg-dark-card shadow-sm transition ${t.completed ? 'opacity-50' : ''}`}>
                                <button onClick={() => window.fb.updateDoc(window.fb.doc(window.fb.db, "tasks", t.id), { completed: !t.completed })} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${t.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300'}`}>
                                    {t.completed && <i data-lucide="check" className="w-4 h-4"></i>}
                                </button>
                                <span className={`flex-1 font-bold dark:text-white ${t.completed ? 'line-through' : ''}`}>{t.title}</span>
                                <button onClick={() => window.fb.deleteDoc(window.fb.doc(window.fb.db, "tasks", t.id))} className="text-slate-300"><i data-lucide="trash" className="w-4 h-4"></i></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Auth Screen ---
        const AuthScreen = ({ showToast }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');

            const handle = async (e) => {
                e.preventDefault();
                try {
                    if (isLogin) await window.fb.signInWithEmailAndPassword(window.fb.auth, email, pass);
                    else await window.fb.createUserWithEmailAndPassword(window.fb.auth, email, pass);
                    showToast("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
                } catch (err) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error"); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-slate-100 dark:bg-dark-bg">
                    <div className="bg-white dark:bg-dark-card w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl text-center">
                        <div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6"><i data-lucide="graduation-cap" className="text-white w-8 h-8"></i></div>
                        <h2 className="text-2xl font-black mb-8 dark:text-white">{isLogin ? 'Ø¯Ø®ÙˆÙ„' : 'ØªØ³Ø¬ÙŠÙ„'}</h2>
                        <form onSubmit={handle} className="space-y-4">
                            <input type="email" placeholder="Email" className="w-full p-4 rounded-2xl bg-slate-100 dark:bg-dark-bg dark:text-white border-none outline-none" onChange={e=>setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" className="w-full p-4 rounded-2xl bg-slate-100 dark:bg-dark-bg dark:text-white border-none outline-none" onChange={e=>setPass(e.target.value)} />
                            <button className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
                        </form>
                        <button onClick={() => setIsLogin(!isLogin)} className="mt-6 text-indigo-600 font-bold text-sm underline">{isLogin ? 'Ø³Ø¬Ù„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯' : 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„'}</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
