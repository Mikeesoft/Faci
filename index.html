<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¬Ø§Ù…Ø¹ØªÙŠ - Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨</title>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', border: '#334155', text: '#f8fafc', muted: '#94a3b8' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.4s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; transition: background-color 0.3s; -webkit-tap-highlight-color: transparent; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; } .dark ::-webkit-scrollbar-thumb { background: #475569; }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-dark-bg dark:text-dark-text selection:bg-indigo-500 selection:text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmCmcR6OIQ00tQrmaTTnoe4kU6L4fQZ00",
            authDomain: "myeduplatform-fe0eb.firebaseapp.com",
            projectId: "myeduplatform-fe0eb",
            storageBucket: "myeduplatform-fe0eb.firebasestorage.app",
            messagingSenderId: "773570577444",
            appId: "1:773570577444:web:c94cc1c8267ecbadd004b1",
            measurementId: "G-6TFV2M7J1G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.fb = { auth, db, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† (ØºÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ø¨Ø±ÙŠØ¯Ùƒ Ø£Ù†Øª) âš ï¸ ---
        const ADMIN_EMAIL = "admin@university.edu"; 

        // --- Shared Components ---
        const Loading = () => <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-dark-bg gap-4"><div className="spinner"></div><p className="text-slate-500 dark:text-dark-muted font-medium animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>;

        // --- 1. Auth Screen ---
        const AuthScreen = () => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                try {
                    const { auth, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.fb;
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (err) { setError("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø§ØªØµØ§Ù„."); } 
                finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen bg-slate-100 dark:bg-dark-bg flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl shadow-xl overflow-hidden border dark:border-dark-border">
                        <div className="bg-indigo-600 p-8 text-center relative overflow-hidden">
                            <div className="absolute inset-0 bg-white/5 transform skew-y-6 scale-150"></div>
                            <i data-lucide="graduation-cap" className="w-14 h-14 text-white mx-auto mb-3 relative z-10"></i>
                            <h1 className="text-2xl font-bold text-white relative z-10">Ø¬Ø§Ù…Ø¹ØªÙŠ</h1>
                            <p className="text-indigo-100 text-sm relative z-10">Ø¨ÙˆØ§Ø¨ØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ¹Ù„Ù…</p>
                        </div>
                        <div className="p-8">
                            <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-6 text-center">{isRegister ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}</h2>
                            {error && <div className="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-3 rounded-xl text-sm mb-4 border border-red-100 dark:border-red-900 flex items-center gap-2"><i data-lucide="alert-circle" className="w-4 h-4"></i>{error}</div>}
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <input type="email" required className="w-full h-12 px-4 border border-slate-200 dark:border-dark-border rounded-xl bg-white dark:bg-dark-bg dark:text-white outline-none focus:ring-2 focus:ring-indigo-500 transition" value={email} onChange={e => setEmail(e.target.value)} placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
                                <input type="password" required className="w-full h-12 px-4 border border-slate-200 dark:border-dark-border rounded-xl bg-white dark:bg-dark-bg dark:text-white outline-none focus:ring-2 focus:ring-indigo-500 transition" value={password} onChange={e => setPassword(e.target.value)} placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
                                <button disabled={loading} className="w-full h-12 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 active:scale-95 transition flex justify-center items-center gap-2">
                                    {loading ? <div className="spinner w-5 h-5 border-2"></div> : (isRegister ? 'ØªØ³Ø¬ÙŠÙ„' : 'Ø¯Ø®ÙˆÙ„')}
                                </button>
                            </form>
                            <button onClick={() => {setIsRegister(!isRegister); setError('');}} className="mt-6 w-full text-indigo-600 dark:text-indigo-400 text-sm hover:underline font-medium transition">{isRegister ? 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„' : 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 2. Training Model (NEW FEATURE: Practice Exams) ---
        const TrainingView = ({ user }) => {
            const [viewMode, setViewMode] = useState('list'); // list, create, take
            const [exams, setExams] = useState([]);
            const [currentExam, setCurrentExam] = useState(null);
            
            // Create Mode State
            const [newExamTitle, setNewExamTitle] = useState('');
            const [questions, setQuestions] = useState([]); // Array of question objects
            const [qType, setQType] = useState('mcq');
            const [qText, setQText] = useState('');
            const [qOptions, setQOptions] = useState(['', '', '', '']);
            const [qCorrect, setQCorrect] = useState(0);
            const [qExplanation, setQExplanation] = useState('');

            // Take Mode State
            const [activeQIndex, setActiveQIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [showExplanation, setShowExplanation] = useState(false);
            const [essayAnswerShown, setEssayAnswerShown] = useState(false);

            const isAdmin = user.email === ADMIN_EMAIL;

            useEffect(() => {
                // Fetch ALL exams (Public data)
                const q = window.fb.query(window.fb.collection(window.fb.db, "practice_exams")); // Public collection
                const unsub = window.fb.onSnapshot(q, (s) => {
                    setExams(s.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setTimeout(() => window.lucide.createIcons(), 100);
                });
                return () => unsub();
            }, []);

            // --- Admin Logic: Create Exam ---
            const addQuestionToBuffer = () => {
                if(!qText) return;
                const newQ = {
                    id: Date.now(),
                    type: qType,
                    text: qText,
                    explanation: qExplanation,
                    options: qType === 'mcq' ? qOptions : [],
                    correct: qType === 'mcq' ? qCorrect : null,
                    modelAnswer: qType === 'essay' ? qExplanation : null // Using explanation field for essay model answer
                };
                setQuestions([...questions, newQ]);
                setQText(''); setQExplanation(''); setQOptions(['', '', '', '']); setQCorrect(0);
            };

            const saveExam = async () => {
                if(!newExamTitle || questions.length === 0) return;
                try {
                    await window.fb.addDoc(window.fb.collection(window.fb.db, "practice_exams"), {
                        title: newExamTitle,
                        questions: questions,
                        createdBy: user.email,
                        createdAt: new Date(),
                        isPublic: true
                    });
                    setViewMode('list'); setNewExamTitle(''); setQuestions([]);
                } catch(err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸"); }
            };

            const deleteExam = async (id) => {
                if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŸ")) await window.fb.deleteDoc(window.fb.doc(window.fb.db, "practice_exams", id));
            };

            // --- Student Logic: Take Exam ---
            const startExam = (exam) => {
                setCurrentExam(exam);
                setActiveQIndex(0);
                setSelectedOption(null);
                setShowExplanation(false);
                setEssayAnswerShown(false);
                setViewMode('take');
            };

            const handleOptionSelect = (idx) => {
                if(selectedOption !== null) return; // Prevent changing answer
                setSelectedOption(idx);
                setShowExplanation(true);
            };

            const nextQuestion = () => {
                if(activeQIndex < currentExam.questions.length - 1) {
                    setActiveQIndex(prev => prev + 1);
                    setSelectedOption(null);
                    setShowExplanation(false);
                    setEssayAnswerShown(false);
                } else {
                    alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ! Ø£Ø­Ø³Ù†Øª ğŸŒŸ");
                    setViewMode('list');
                }
            };

            // --- Render Logic ---

            // 1. List View
            if(viewMode === 'list') return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</h2>
                            <p className="text-sm text-slate-500 dark:text-dark-muted">Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙˆØ±Ø§Ø¬Ø¹ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ ÙÙˆØ±Ø§Ù‹</p>
                        </div>
                        {isAdmin && (
                            <button onClick={()=>setViewMode('create')} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none">
                                <i data-lucide="plus-circle" className="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬
                            </button>
                        )}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {exams.length === 0 ? <div className="col-span-full text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 dark:border-dark-border rounded-2xl">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù…Ø§Ø°Ø¬ Ø­Ø§Ù„ÙŠØ§Ù‹</div> : 
                        exams.map(exam => (
                            <div key={exam.id} className="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-100 dark:border-dark-border shadow-sm hover:shadow-md transition group relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-2 h-full bg-indigo-500"></div>
                                <div className="flex justify-between items-start mb-4 pl-4">
                                    <h3 className="font-bold text-lg text-slate-800 dark:text-white">{exam.title}</h3>
                                    {isAdmin && <button onClick={(e)=>{e.stopPropagation(); deleteExam(exam.id)}} className="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" className="w-4 h-4"></i></button>}
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-xs bg-slate-100 dark:bg-dark-bg px-2 py-1 rounded text-slate-600 dark:text-dark-muted font-medium">{exam.questions.length} Ø³Ø¤Ø§Ù„</span>
                                    <button onClick={()=>startExam(exam)} className="text-indigo-600 dark:text-indigo-400 font-bold text-sm flex items-center gap-1 group-hover:translate-x-[-5px] transition-transform">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± <i data-lucide="arrow-left" className="w-4 h-4"></i></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // 2. Create View (Admin Only)
            if(viewMode === 'create' && isAdmin) return (
                <div className="space-y-6 animate-fade-in max-w-3xl mx-auto">
                    <div className="flex items-center gap-3 mb-6">
                        <button onClick={()=>setViewMode('list')} className="p-2 bg-slate-100 dark:bg-dark-card rounded-full"><i data-lucide="arrow-right" className="w-5 h-5 dark:text-white"></i></button>
                        <h2 className="text-2xl font-bold text-slate-800 dark:text-white">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯</h2>
                    </div>

                    <div className="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-200 dark:border-dark-border space-y-4">
                        <input className="w-full px-4 py-3 text-lg font-bold border-b border-slate-200 dark:border-dark-border bg-transparent outline-none dark:text-white" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù…Ø«Ø§Ù„: ÙƒÙˆÙŠØ² ÙÙŠØ²ÙŠØ§Ø¡ 1)" value={newExamTitle} onChange={e=>setNewExamTitle(e.target.value)} />
                        
                        {/* Question Builder */}
                        <div className="bg-slate-50 dark:bg-dark-bg/50 p-4 rounded-xl space-y-3 border border-slate-200 dark:border-dark-border">
                            <div className="flex justify-between">
                                <h4 className="font-bold text-sm text-slate-600 dark:text-dark-muted">Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ ({questions.length + 1})</h4>
                                <div className="flex gap-2 text-xs">
                                    <button onClick={()=>setQType('mcq')} className={`px-3 py-1 rounded-full transition ${qType==='mcq'?'bg-indigo-600 text-white':'bg-slate-200 dark:bg-dark-border dark:text-white'}`}>Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
                                    <button onClick={()=>setQType('essay')} className={`px-3 py-1 rounded-full transition ${qType==='essay'?'bg-indigo-600 text-white':'bg-slate-200 dark:bg-dark-border dark:text-white'}`}>Ù…Ù‚Ø§Ù„ÙŠ</button>
                                </div>
                            </div>
                            
                            <textarea className="w-full p-3 rounded-lg border dark:border-dark-border dark:bg-dark-bg dark:text-white outline-none" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„..." value={qText} onChange={e=>setQText(e.target.value)}></textarea>
                            
                            {qType === 'mcq' && (
                                <div className="space-y-2">
                                    {qOptions.map((opt, i) => (
                                        <div key={i} className="flex items-center gap-2">
                                            <input type="radio" name="correctObj" checked={qCorrect === i} onChange={()=>setQCorrect(i)} className="w-4 h-4 accent-indigo-600" />
                                            <input className="flex-1 px-3 py-2 text-sm border rounded-lg dark:bg-dark-bg dark:border-dark-border dark:text-white" placeholder={`Ø®ÙŠØ§Ø± ${i+1}`} value={opt} onChange={e=>{const newOps=[...qOptions]; newOps[i]=e.target.value; setQOptions(newOps)}} />
                                        </div>
                                    ))}
                                    <p className="text-[10px] text-slate-400">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</p>
                                </div>
                            )}

                            <textarea className="w-full p-3 rounded-lg border dark:border-dark-border dark:bg-dark-bg dark:text-white outline-none text-sm" rows="2" placeholder={qType==='mcq' ? "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ù„)..." : "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©..."} value={qExplanation} onChange={e=>setQExplanation(e.target.value)}></textarea>

                            <button onClick={addQuestionToBuffer} className="w-full py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-900 transition">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                        </div>

                        {/* List of added questions */}
                        {questions.length > 0 && (
                            <div className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                {questions.map((q, i) => (
                                    <div key={i} className="flex justify-between p-2 bg-slate-50 dark:bg-dark-bg rounded border dark:border-dark-border">
                                        <span className="truncate text-sm dark:text-white w-3/4">{i+1}. {q.text}</span>
                                        <span className="text-xs px-2 py-0.5 bg-white dark:bg-dark-card rounded border dark:border-dark-border dark:text-dark-muted">{q.type === 'mcq' ? 'MCQ' : 'Ù…Ù‚Ø§Ù„'}</span>
                                    </div>
                                ))}
                            </div>
                        )}

                        <div className="pt-4 border-t border-slate-100 dark:border-dark-border">
                            <button onClick={saveExam} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none">Ù†Ø´Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
                        </div>
                    </div>
                </div>
            );

            // 3. Take Exam View (Student)
            if(viewMode === 'take' && currentExam) {
                const q = currentExam.questions[activeQIndex];
                const isLast = activeQIndex === currentExam.questions.length - 1;

                return (
                    <div className="space-y-6 animate-fade-in max-w-2xl mx-auto pb-20">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg text-slate-800 dark:text-white truncate max-w-[200px]">{currentExam.title}</h3>
                            <span className="bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full text-xs font-bold font-mono">
                                Ø§Ù„Ø³Ø¤Ø§Ù„ {activeQIndex + 1} / {currentExam.questions.length}
                            </span>
                        </div>

                        {/* Progress Bar */}
                        <div className="w-full bg-slate-200 dark:bg-dark-border h-1.5 rounded-full overflow-hidden">
                            <div className="bg-indigo-600 h-full transition-all duration-500" style={{width: `${((activeQIndex + 1) / currentExam.questions.length) * 100}%`}}></div>
                        </div>

                        {/* Question Card */}
                        <div className="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-dark-border min-h-[300px] flex flex-col">
                            <div className="flex-1">
                                <h2 className="text-xl font-bold text-slate-900 dark:text-white mb-6 leading-relaxed">{q.text}</h2>

                                {q.type === 'mcq' ? (
                                    <div className="space-y-3">
                                        {q.options.map((opt, idx) => {
                                            let btnClass = "w-full text-right p-4 rounded-xl border-2 transition-all font-medium text-sm md:text-base ";
                                            if (selectedOption === null) {
                                                btnClass += "border-slate-100 dark:border-dark-border hover:border-indigo-200 dark:hover:border-indigo-900 bg-slate-50 dark:bg-dark-bg dark:text-white";
                                            } else {
                                                // Feedback Logic
                                                if (idx === q.correct) btnClass += "border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400"; // Correct
                                                else if (idx === selectedOption) btnClass += "border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400"; // Wrong Selected
                                                else btnClass += "border-slate-100 dark:border-dark-border opacity-50 dark:bg-dark-bg dark:text-dark-muted"; // Others
                                            }

                                            return (
                                                <button key={idx} disabled={selectedOption !== null} onClick={() => handleOptionSelect(idx)} className={btnClass}>
                                                    <span className="ml-2 inline-block w-6 h-6 text-center leading-6 rounded-full bg-white dark:bg-dark-card text-xs border border-slate-200 dark:border-dark-border">{String.fromCharCode(65+idx)}</span>
                                                    {opt}
                                                </button>
                                            )
                                        })}
                                    </div>
                                ) : (
                                    // Essay Logic
                                    <div className="space-y-4">
                                        <textarea className="w-full p-4 border rounded-xl dark:bg-dark-bg dark:border-dark-border dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                                        <button onClick={()=>setEssayAnswerShown(!essayAnswerShown)} className="text-indigo-600 dark:text-indigo-400 text-sm font-bold underline">
                                            {essayAnswerShown ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©' : 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©'}
                                        </button>
                                    </div>
                                )}

                                {/* Explanation / Model Answer Box */}
                                {(showExplanation || essayAnswerShown) && q.explanation && (
                                    <div className="mt-6 bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900 p-4 rounded-xl animate-fade-in">
                                        <div className="flex items-center gap-2 mb-1 text-blue-800 dark:text-blue-300 font-bold text-sm">
                                            <i data-lucide="lightbulb" className="w-4 h-4"></i> {q.type === 'mcq' ? 'Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:' : 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:'}
                                        </div>
                                        <p className="text-slate-700 dark:text-slate-300 text-sm leading-relaxed">{q.explanation}</p>
                                    </div>
                                )}
                            </div>

                            {/* Navigation */}
                            <div className="mt-8 pt-4 border-t border-slate-100 dark:border-dark-border flex justify-end">
                                <button 
                                    disabled={q.type === 'mcq' && selectedOption === null} 
                                    onClick={nextQuestion} 
                                    className="bg-slate-900 dark:bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-800 dark:hover:bg-indigo-700 transition"
                                >
                                    {isLast ? 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬' : 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ'} <i data-lucide={isLast ? "check-circle" : "arrow-left"} className="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null; // Fallback
        };

        // --- 4. Dashboard (Updated Sidebar) ---
        const Dashboard = ({ user }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');

            useEffect(() => {
                if(darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', darkMode ? 'dark' : 'light');
            }, [darkMode]);

            useEffect(() => { setTimeout(() => window.lucide.createIcons(), 50); }, [activeTab, showMobileMenu]);

            const NavItem = ({ id, icon, label }) => (
                <button onClick={() => { setActiveTab(id); setShowMobileMenu(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === id ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-dark-muted hover:bg-slate-50 dark:hover:bg-dark-bg hover:text-slate-700 dark:hover:text-white'}`}>
                    <i data-lucide={icon} className="w-5 h-5"></i><span>{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-dark-bg transition-colors flex">
                    <aside className="hidden md:flex flex-col w-72 bg-white dark:bg-dark-card border-l border-slate-200 dark:border-dark-border p-6 shadow-sm z-50 sticky top-0 h-screen">
                        <div className="flex items-center gap-3 px-2 mb-10"><div className="bg-indigo-600 p-2 rounded-lg shadow-lg"><i data-lucide="graduation-cap" className="text-white w-6 h-6"></i></div><span className="font-bold text-2xl text-slate-800 dark:text-white tracking-tight">Ø¬Ø§Ù…Ø¹ØªÙŠ</span></div>
                        <nav className="flex-1 space-y-2">
                            <NavItem id="home" icon="layout-grid" label="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" />
                            <NavItem id="training" icon="file-question" label="Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨" /> 
                            {/* --- New Tab Added Above --- */}
                            <NavItem id="exams" icon="alarm-clock" label="ØºØ±ÙØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª" />
                            <NavItem id="courses" icon="book-open" label="Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª" />
                            <NavItem id="tasks" icon="list-todo" label="Ø§Ù„Ù…Ù‡Ø§Ù…" />
                        </nav>
                        <div className="pt-6 border-t border-slate-100 dark:border-dark-border space-y-3">
                            <button onClick={()=>setDarkMode(!darkMode)} className="w-full flex items-center gap-3 px-4 py-3 bg-slate-50 dark:bg-dark-bg rounded-xl text-slate-600 dark:text-dark-muted font-bold"><i data-lucide={darkMode?"sun":"moon"} className="w-5 h-5"></i>{darkMode?'Ù†Ù‡Ø§Ø±ÙŠ':'Ù„ÙŠÙ„ÙŠ'}</button>
                            <button onClick={()=>{if(confirm('Ø®Ø±ÙˆØ¬ØŸ'))window.fb.signOut(window.fb.auth)}} className="w-full flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl text-sm font-bold"><i data-lucide="log-out" className="w-5 h-5"></i> Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </aside>
                    <div className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="md:hidden bg-white dark:bg-dark-card border-b border-slate-200 dark:border-dark-border p-4 flex justify-between items-center z-50 sticky top-0 shadow-sm"><div className="flex items-center gap-2"><i data-lucide="graduation-cap" className="text-indigo-600 dark:text-indigo-400 w-6 h-6"></i><span className="font-bold text-lg text-slate-800 dark:text-white">Ø¬Ø§Ù…Ø¹ØªÙŠ</span></div><div className="flex gap-2"><button onClick={()=>setDarkMode(!darkMode)} className="p-2 bg-slate-100 dark:bg-dark-bg rounded-lg"><i data-lucide={darkMode?"sun":"moon"} className="w-5 h-5 text-slate-600 dark:text-dark-muted"></i></button><button onClick={()=>setShowMobileMenu(!showMobileMenu)} className="p-2 bg-slate-100 dark:bg-dark-bg rounded-lg"><i data-lucide={showMobileMenu?"x":"menu"} className="w-6 h-6 text-slate-600 dark:text-dark-muted"></i></button></div></header>
                        {showMobileMenu && <div className="md:hidden fixed inset-0 top-[60px] bg-white dark:bg-dark-card z-40 p-4 space-y-2 animate-in slide-in-from-top-2 border-t dark:border-dark-border"><NavItem id="home" icon="layout-grid" label="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" /><NavItem id="training" icon="file-question" label="Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨" /><NavItem id="exams" icon="alarm-clock" label="Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª" /><NavItem id="courses" icon="book-open" label="Ø§Ù„Ù…ÙˆØ§Ø¯" /><NavItem id="tasks" icon="list-todo" label="Ø§Ù„Ù…Ù‡Ø§Ù…" /><div className="h-px bg-slate-100 dark:bg-dark-border my-4"></div><button onClick={()=>window.fb.signOut(window.fb.auth)} className="w-full flex items-center gap-3 px-4 py-3 text-red-500 font-bold"><i data-lucide="log-out" className="w-5 h-5"></i> Ø®Ø±ÙˆØ¬</button></div>}
                        <main className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar pb-20"><div className="max-w-5xl mx-auto">
                            {/* --- Injecting Views Here --- */}
                            {activeTab === 'training' && <TrainingView user={user} />}
                            {activeTab === 'home' && <HomeView user={user} setTab={setActiveTab} />}
                            {activeTab === 'exams' && <ExamsView user={user} />}
                            {activeTab === 'courses' && <CoursesView user={user} />}
                            {activeTab === 'tasks' && <TasksView user={user} />}
                        </div></main>
                    </div>
                </div>
            );
        };

        // --- Existing Components (Shortened for brevity but functionality preserved) ---
        // I'll keep the previous "Ultra" components here (ExamsView, CoursesView, TasksView, HomeView, Pomodoro)
        // just embedding them back into the code structure above Dashboard for completion.
        
        // --- (Previous Home, Exams, Courses, Tasks, Pomodoro Components Go Here - Identical to previous response) ---
        // For the sake of the single-file request, I will include the MINIFIED versions of the previous components below 
        // to make sure it works out-of-the-box.

        const PomodoroTimer=()=>{const[t,sT]=useState(1500), [a,sA]=useState(!1),[m,sM]=useState('f'); useEffect(()=>{let i;if(a&&t>0)i=setInterval(()=>sT(p=>p-1),1000);else if(t===0){sA(!1);alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª");}return()=>clearInterval(i)},[a,t]); return <div className="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-100 dark:border-dark-border mb-8 shadow-sm relative overflow-hidden"><div className="flex justify-between mb-6 relative z-10"><h3 className="font-bold dark:text-white flex gap-2"><i data-lucide="timer" className="w-5 text-indigo-500"></i> Ù…Ø¤Ù‚Øª</h3><div className="bg-slate-100 dark:bg-dark-bg p-1 rounded-lg flex"><button onClick={()=>{sM('f');sA(!1);sT(1500)}} className={`px-3 py-1 rounded text-xs font-bold ${m==='f'?'bg-white dark:bg-indigo-600 shadow':'text-slate-500'}`}>Ù…Ø°Ø§ÙƒØ±Ø©</button><button onClick={()=>{sM('b');sA(!1);sT(300)}} className={`px-3 py-1 rounded text-xs font-bold ${m==='b'?'bg-white dark:bg-emerald-600 shadow':'text-slate-500'}`}>Ø±Ø§Ø­Ø©</button></div></div><div className="text-center relative z-10"><div className="text-6xl font-bold font-mono dark:text-white mb-6">{Math.floor(t/60)}:{(t%60).toString().padStart(2,'0')}</div><div className="flex justify-center gap-4"><button onClick={()=>sA(!a)} className={`w-12 h-12 rounded-full flex items-center justify-center text-white ${a?'bg-orange-500':'bg-indigo-600'}`}><i data-lucide={a?"pause":"play"} className="w-5"></i></button><button onClick={()=>{sA(!1);sT(m==='f'?1500:300)}} className="w-12 h-12 rounded-full bg-slate-100 dark:bg-dark-bg dark:text-white flex items-center justify-center"><i data-lucide="rotate-ccw" className="w-5"></i></button></div></div></div>};

        const ExamsView=({user})=>{const[e,sE]=useState([]), [n,sN]=useState({subject:'',type:'Final',date:'',location:''}); useEffect(()=>{return window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"exams"),window.fb.where("uid","==",user.uid)),s=>sE(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(a.date)-new Date(b.date))))},[user]); const add=async(ev)=>{ev.preventDefault();if(n.subject)await window.fb.addDoc(window.fb.collection(window.fb.db,"exams"),{uid:user.uid,...n});sN({subject:'',type:'Final',date:'',location:''})}; return <div className="space-y-6 animate-fade-in"><h2 className="text-2xl font-bold dark:text-white">ØºØ±ÙØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2><div className="bg-white dark:bg-dark-card p-5 rounded-2xl border dark:border-dark-border"><form onSubmit={add} className="grid grid-cols-2 md:grid-cols-5 gap-3"><input className="col-span-2 w-full h-10 px-3 border rounded dark:bg-dark-bg dark:border-dark-border dark:text-white" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" value={n.subject} onChange={x=>sN({...n,subject:x.target.value})}/><select className="w-full h-10 px-2 border rounded dark:bg-dark-bg dark:border-dark-border dark:text-white" value={n.type} onChange={x=>sN({...n,type:x.target.value})}><option>Final</option><option>Midterm</option><option>Quiz</option></select><input type="datetime-local" className="col-span-2 md:col-span-1 w-full h-10 px-2 border rounded dark:bg-dark-bg dark:border-dark-border dark:text-white" value={n.date} onChange={x=>sN({...n,date:x.target.value})}/><button className="w-full h-10 bg-red-600 text-white rounded font-bold">Ø¥Ø¶Ø§ÙØ©</button></form></div><div className="grid md:grid-cols-2 gap-4">{e.map(x=><div key={x.id} className="p-4 bg-white dark:bg-dark-card border dark:border-dark-border rounded-xl shadow-sm"><div className="flex justify-between mb-2"><h3 className="font-bold dark:text-white">{x.subject} <span className="text-xs bg-slate-100 dark:bg-dark-bg px-2 py-0.5 rounded">{x.type}</span></h3><button onClick={()=>window.fb.deleteDoc(window.fb.doc(window.fb.db,"exams",x.id))} className="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" className="w-4"></i></button></div><div className="text-sm text-slate-500 dark:text-dark-muted"><i data-lucide="calendar" className="inline w-3 ml-1"/>{new Date(x.date).toLocaleDateString()}</div></div>)}</div></div>};

        const CoursesView=({user})=>{const[c,sC]=useState([]),[n,sN]=useState({name:'',doctor:'',day:'Ø§Ù„Ø£Ø­Ø¯',maxAbsence:4,credits:3,grade:''}); useEffect(()=>{return window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"courses"),window.fb.where("uid","==",user.uid)),s=>sC(s.docs.map(d=>({id:d.id,...d.data()}))))},[user]); const add=async(ev)=>{ev.preventDefault();if(n.name)await window.fb.addDoc(window.fb.collection(window.fb.db,"courses"),{uid:user.uid,...n,absences:0});sN({...n,name:''})}; const up=async(id,v)=>window.fb.updateDoc(window.fb.doc(window.fb.db,"courses",id),{absences:v}); return <div className="space-y-6 animate-fade-in"><h2 className="text-2xl font-bold dark:text-white">Ø§Ù„Ù…ÙˆØ§Ø¯</h2><div className="bg-white dark:bg-dark-card p-5 rounded-2xl border dark:border-dark-border"><form onSubmit={add} className="grid grid-cols-2 md:grid-cols-4 gap-3"><input className="w-full h-10 px-3 border rounded dark:bg-dark-bg dark:border-dark-border dark:text-white" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" value={n.name} onChange={e=>sN({...n,name:e.target.value})}/><input className="w-full h-10 px-3 border rounded dark:bg-dark-bg dark:border-dark-border dark:text-white" placeholder="Ø¯ÙƒØªÙˆØ±" value={n.doctor} onChange={e=>sN({...n,doctor:e.target.value})}/><button className="w-full h-10 bg-indigo-600 text-white rounded font-bold">Ø­ÙØ¸</button></form></div><div className="grid md:grid-cols-2 gap-4">{c.map(x=>{const p=Math.min(((x.absences||0)/x.maxAbsence)*100,100); const danger=(x.absences||0)>=x.maxAbsence-1; return <div key={x.id} className={`p-5 bg-white dark:bg-dark-card border rounded-xl ${danger?'border-red-300 dark:border-red-900':'dark:border-dark-border'}`}><div className="flex justify-between mb-3"><h3 className="font-bold dark:text-white">{x.name}</h3><button onClick={()=>window.fb.deleteDoc(window.fb.doc(window.fb.db,"courses",x.id))} className="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" className="w-4"></i></button></div><div className="flex justify-between items-center mb-2 text-sm dark:text-white"><span>ØºÙŠØ§Ø¨: {x.absences}/{x.maxAbsence}</span><div><button onClick={()=>up(x.id,Math.max(0,(x.absences||0)-1))} className="mx-1 px-2 border rounded">-</button><button onClick={()=>up(x.id,(x.absences||0)+1)} className="mx-1 px-2 border rounded">+</button></div></div><div className="h-1.5 w-full bg-slate-100 dark:bg-dark-bg rounded-full overflow-hidden"><div className={`h-full ${danger?'bg-red-500':'bg-indigo-500'}`} style={{width:`${p}%`}}></div></div>{danger&&<p className="text-xs text-red-500 mt-1 font-bold animate-pulse">ØªØ­Ø°ÙŠØ±: Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ø§Ù„Ø­Ø±Ù…Ø§Ù†</p>}</div>})}</div></div>};

        const TasksView=({user})=>{const[t,sT]=useState([]),[n,sN]=useState(''); useEffect(()=>{return window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"tasks"),window.fb.where("uid","==",user.uid)),s=>sT(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>b.createdAt?.seconds-a.createdAt?.seconds)))},[user]); const add=async(e)=>{e.preventDefault();if(n)await window.fb.addDoc(window.fb.collection(window.fb.db,"tasks"),{uid:user.uid,title:n,completed:!1,createdAt:new Date()});sN('')}; return <div className="space-y-6 animate-fade-in"><h2 className="text-2xl font-bold dark:text-white">Ø§Ù„Ù…Ù‡Ø§Ù…</h2><form onSubmit={add} className="relative"><input className="w-full h-12 pl-12 pr-4 border rounded-xl dark:bg-dark-card dark:border-dark-border dark:text-white" value={n} onChange={e=>sN(e.target.value)} placeholder="Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..."/><button className="absolute left-3 top-3"><i data-lucide="plus" className="text-indigo-600"></i></button></form><div className="space-y-2">{t.map(x=><div key={x.id} className={`flex items-center gap-3 p-3 border rounded-xl ${x.completed?'opacity-50 bg-slate-50 dark:bg-dark-bg':'bg-white dark:bg-dark-card dark:border-dark-border'}`}><button onClick={()=>window.fb.updateDoc(window.fb.doc(window.fb.db,"tasks",x.id),{completed:!x.completed})} className={`w-5 h-5 rounded-full border flex items-center justify-center ${x.completed?'bg-green-500 border-green-500':''}`}>{x.completed&&<i data-lucide="check" className="w-3 text-white"/>}</button><span className={`flex-1 ${x.completed?'line-through':''} dark:text-white`}>{x.title}</span><button onClick={()=>window.fb.deleteDoc(window.fb.doc(window.fb.db,"tasks",x.id))}><i data-lucide="trash-2" className="w-4 text-slate-300 hover:text-red-500"/></button></div>)}</div></div>};

        const HomeView=({user,setTab})=>{const[s,sS]=useState({c:0,t:0}); useEffect(()=>{window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"courses"),window.fb.where("uid","==",user.uid)),x=>sS(p=>({...p,c:x.size})));window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"tasks"),window.fb.where("uid","==",user.uid),window.fb.where("completed","==",!1)),x=>sS(p=>({...p,t:x.size})))},[user]); return <div className="space-y-8 animate-fade-in"><div className="bg-indigo-600 p-8 rounded-3xl text-white shadow-xl relative overflow-hidden"><h1 className="text-3xl font-bold relative z-10">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</h1><i data-lucide="award" className="absolute left-4 bottom-[-20px] w-32 h-32 opacity-10"/></div><div className="grid md:grid-cols-2 gap-6"><div onClick={()=>setTab('courses')} className="p-6 bg-white dark:bg-dark-card border dark:border-dark-border rounded-2xl shadow-sm cursor-pointer"><h3 className="text-slate-500 dark:text-dark-muted font-bold">Ù…ÙˆØ§Ø¯ Ù…Ø³Ø¬Ù„Ø©</h3><span className="text-4xl font-bold dark:text-white">{s.c}</span></div><div onClick={()=>setTab('tasks')} className="p-6 bg-white dark:bg-dark-card border dark:border-dark-border rounded-2xl shadow-sm cursor-pointer"><h3 className="text-slate-500 dark:text-dark-muted font-bold">Ù…Ù‡Ø§Ù… Ù…ØªØ¨Ù‚ÙŠØ©</h3><span className="text-4xl font-bold dark:text-white">{s.t}</span></div></div></div>};

        // --- Root ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [ready, setReady] = useState(false);
            useEffect(() => { const init = () => { if (window.fb) { setReady(true); window.fb.onAuthStateChanged(window.fb.auth, setUser); } }; if (window.fb) init(); else window.addEventListener('firebase-ready', init); }, []);
            if (!ready) return <Loading />;
            return user ? <Dashboard user={user} /> : <AuthScreen />;
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>