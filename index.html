<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>جامعتي - المنصة البلاتينية</title>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', border: '#334155', text: '#f8fafc', input: '#020617' }
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'bounce-slow': 'bounce 3s infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; transition: background-color 0.3s; -webkit-tap-highlight-color: transparent; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; } .dark ::-webkit-scrollbar-thumb { background: #475569; }
        input, select, textarea { font-size: 16px !important; }
        
        /* Toast Notification Style */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 24px; border-radius: 12px; color: white; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: fadeIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; min-width: 300px; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-dark-bg dark:text-dark-text selection:bg-indigo-500 selection:text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, getDocs, setDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmCmcR6OIQ00tQrmaTTnoe4kU6L4fQZ00",
            authDomain: "myeduplatform-fe0eb.firebaseapp.com",
            projectId: "myeduplatform-fe0eb",
            storageBucket: "myeduplatform-fe0eb.firebasestorage.app",
            messagingSenderId: "773570577444",
            appId: "1:773570577444:web:c94cc1c8267ecbadd004b1",
            measurementId: "G-6TFV2M7J1G"
        };

        const app = initializeApp(firebaseConfig);
        window.fb = { 
            auth: getAuth(app), db: getFirestore(app), 
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, 
            collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, getDocs, setDoc, orderBy, limit 
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext, useMemo } = React;

        // --- إعدادات الأدمن ---
        const ADMIN_EMAIL = "mohammadsafe202a@gmail.com"; 

        // --- Helper: Sanitization ---
        const sanitize = (str) => typeof str === 'string' ? str.replace(/</g, "&lt;").replace(/>/g, "&gt;").trim() : str;

        // --- UI Context (Toasts & Modals instead of Alerts) ---
        const UIContext = createContext();
        const useUI = () => useContext(UIContext);

        const UIProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const [modal, setModal] = useState(null);

            const showToast = (msg, type='success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
            };

            const showConfirm = (title, message, onConfirm) => {
                setModal({ title, message, onConfirm });
            };

            const closeModal = () => setModal(null);

            return (
                <UIContext.Provider value={{ showToast, showConfirm }}>
                    {children}
                    {/* Toast Container */}
                    <div className="toast-container">
                        {toasts.map(t => (
                            <div key={t.id} className={`toast ${t.type}`}>
                                <i data-lucide={t.type==='success'?'check-circle':t.type==='error'?'alert-circle':'info'} className="w-5 h-5"></i>
                                {t.msg}
                            </div>
                        ))}
                    </div>
                    {/* Modal Container */}
                    {modal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                            <div className="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-2xl w-full max-w-sm border dark:border-dark-border transform scale-100">
                                <h3 className="text-xl font-bold mb-2 dark:text-white">{modal.title}</h3>
                                <p className="text-slate-600 dark:text-slate-300 mb-6">{modal.message}</p>
                                <div className="flex gap-3">
                                    <button onClick={() => { modal.onConfirm(); closeModal(); }} className="flex-1 bg-red-600 text-white py-2.5 rounded-xl font-bold hover:bg-red-700 transition">نعم</button>
                                    <button onClick={closeModal} className="flex-1 bg-slate-100 dark:bg-dark-bg text-slate-700 dark:text-white py-2.5 rounded-xl font-bold hover:bg-slate-200 transition">إلغاء</button>
                                </div>
                            </div>
                        </div>
                    )}
                </UIContext.Provider>
            );
        };

        // --- Broadcast Overlay (For 5-second updates) ---
        const BroadcastOverlay = () => {
            const [msg, setMsg] = useState(null);
            useEffect(() => {
                const q = window.fb.query(window.fb.collection(window.fb.db, "broadcasts"), window.fb.orderBy("timestamp", "desc"), window.fb.limit(1));
                const unsub = window.fb.onSnapshot(q, s => {
                    if(!s.empty) {
                        const data = s.docs[0].data();
                        // Show only if created in last 10s
                        if (new Date() - data.timestamp?.toDate() < 10000) {
                            setMsg(data.message);
                            setTimeout(() => setMsg(null), 5000);
                        }
                    }
                });
                return () => unsub();
            }, []);

            if (!msg) return null;
            return (
                <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[90%] max-w-md bg-slate-900/90 dark:bg-indigo-600/90 backdrop-blur-md text-white p-4 rounded-2xl z-[9999] animate-slide-up shadow-2xl flex items-center gap-4 border border-white/10">
                    <div className="bg-white/20 p-2 rounded-full"><i data-lucide="megaphone" className="w-6 h-6 animate-pulse"></i></div>
                    <div>
                        <p className="text-[10px] font-bold opacity-70 uppercase tracking-widest">تحديث عاجل</p>
                        <p className="font-bold text-sm leading-tight">{msg}</p>
                    </div>
                </div>
            );
        };

        // --- Notification Bell ---
        const NotificationBell = () => {
            const [hasNew, setHasNew] = useState(false);
            const [show, setShow] = useState(false);
            const [notifs, setNotifs] = useState([]);

            useEffect(() => {
                // Listen to public events (Exams & Broadcasts)
                const q1 = window.fb.query(window.fb.collection(window.fb.db, "exams"), window.fb.orderBy("createdAt", "desc"), window.fb.limit(3));
                const unsub = window.fb.onSnapshot(q1, s => {
                    const data = s.docs.map(d => ({ type: 'exam', title: d.data().subject, msg: 'تم إضافة امتحان جديد', time: d.data().createdAt }));
                    setNotifs(data);
                    if(data.length > 0 && (new Date() - data[0].time?.toDate() < 60000)) setHasNew(true);
                });
                return () => unsub();
            }, []);

            return (
                <div className="relative">
                    <button onClick={()=>{setShow(!show); setHasNew(false);}} className="p-2 bg-slate-100 dark:bg-dark-bg rounded-xl relative hover:bg-slate-200 transition">
                        <i data-lucide="bell" className="w-5 h-5 dark:text-white"></i>
                        {hasNew && <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-dark-card animate-ping"></span>}
                        {hasNew && <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-dark-card"></span>}
                    </button>
                    {show && (
                        <div className="absolute left-0 top-14 w-72 bg-white dark:bg-dark-card shadow-2xl rounded-2xl p-2 z-50 border dark:border-dark-border animate-fade-in">
                            <h4 className="text-xs font-bold text-slate-400 p-2 uppercase tracking-wider">الإشعارات</h4>
                            <div className="max-h-60 overflow-y-auto custom-scrollbar">
                                {notifs.length === 0 ? <p className="text-center text-xs p-4 text-slate-400">لا توجد إشعارات جديدة</p> : 
                                notifs.map((n, i) => (
                                    <div key={i} className="p-3 hover:bg-slate-50 dark:hover:bg-dark-bg rounded-xl flex gap-3 items-start transition border-b dark:border-dark-border last:border-0">
                                        <div className="bg-indigo-100 dark:bg-indigo-900/50 p-2 rounded-lg"><i data-lucide="calendar" className="w-4 h-4 text-indigo-600 dark:text-indigo-400"></i></div>
                                        <div>
                                            <p className="text-sm font-bold dark:text-white">{n.msg}</p>
                                            <p className="text-xs text-slate-500 dark:text-slate-400">{n.title}</p>
                                            <p className="text-[10px] text-slate-400 mt-1">{n.time?.toDate().toLocaleTimeString('ar-EG')}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Shared Components ---
        const Loading = () => <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-dark-bg gap-4"><div className="spinner"></div><p className="text-slate-500 dark:text-dark-muted font-medium animate-pulse">جاري التحميل...</p></div>;

        // --- 1. Auth ---
        const AuthScreen = () => {
            const [isReg, setIsReg] = useState(false);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [loading, setLoading] = useState(false);
            const { showToast } = useUI();

            const submit = async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    const { auth, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.fb;
                    if(isReg) await createUserWithEmailAndPassword(auth, email, pass);
                    else await signInWithEmailAndPassword(auth, email, pass);
                } catch(err) { showToast("خطأ في البيانات", "error"); } 
                finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-dark-bg p-4">
                    <div className="bg-white dark:bg-dark-card w-full max-w-md p-8 rounded-3xl shadow-2xl border dark:border-dark-border">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200 dark:shadow-none"><i data-lucide="graduation-cap" className="w-8 h-8 text-white"></i></div>
                            <h1 className="text-2xl font-bold dark:text-white">جامعتي</h1>
                            <p className="text-slate-500 text-sm">منصة التعليم الذكية</p>
                        </div>
                        <form onSubmit={submit} className="space-y-4">
                            <input className="w-full p-4 border rounded-xl dark:bg-dark-input dark:border-dark-border dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" type="email" placeholder="البريد الجامعي" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input className="w-full p-4 border rounded-xl dark:bg-dark-input dark:border-dark-border dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" type="password" placeholder="كلمة المرور" value={pass} onChange={e=>setPass(e.target.value)} required />
                            <button disabled={loading} className="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold hover:bg-indigo-700 transition flex justify-center">{loading?<div className="spinner w-6 h-6 border-2"></div>:(isReg?'تسجيل جديد':'دخول')}</button>
                        </form>
                        <button onClick={()=>setIsReg(!isReg)} className="w-full mt-6 text-indigo-600 font-bold text-sm">{isReg?'لديك حساب؟':'إنشاء حساب'}</button>
                    </div>
                </div>
            );
        };

        // --- 2. Forum (New Feature) ---
        const ForumView = ({ user }) => {
            const [posts, setPosts] = useState([]);
            const [newPost, setNewPost] = useState('');
            const [replyText, setReplyText] = useState({});
            const isAdmin = user.email === ADMIN_EMAIL;
            const { showToast, showConfirm } = useUI();

            useEffect(() => {
                const q = window.fb.query(window.fb.collection(window.fb.db, "forum"), window.fb.orderBy("ts", "desc"));
                return window.fb.onSnapshot(q, s => {
                    setPosts(s.docs.map(d => ({id:d.id, ...d.data()})));
                    setTimeout(()=>window.lucide.createIcons(), 100);
                });
            }, []);

            const addPost = async () => {
                if(!newPost.trim()) return;
                await window.fb.addDoc(window.fb.collection(window.fb.db, "forum"), {
                    text: sanitize(newPost), user: user.displayName||"طالب", uid: user.uid, ts: new Date(), reply: null
                });
                setNewPost(''); showToast("تم إرسال سؤالك");
            };

            const sendReply = async (id) => {
                if(!replyText[id]) return;
                await window.fb.updateDoc(window.fb.doc(window.fb.db, "forum", id), { reply: sanitize(replyText[id]), replyBy: user.displayName||"الأدمن" });
                setReplyText({...replyText, [id]: ''}); showToast("تم الرد");
            };

            const delPost = (id) => showConfirm("حذف السؤال؟", "سيتم حذفه نهائياً", async() => {
                await window.fb.deleteDoc(window.fb.doc(window.fb.db, "forum", id)); showToast("تم الحذف", "error");
            });

            return (
                <div className="space-y-6 animate-fade-in max-w-3xl mx-auto">
                    <h2 className="text-2xl font-bold dark:text-white flex items-center gap-2"><i data-lucide="messages-square" className="text-indigo-500"></i> المنتدى</h2>
                    
                    <div className="bg-white dark:bg-dark-card p-4 rounded-2xl border dark:border-dark-border shadow-sm">
                        <textarea className="w-full p-4 bg-slate-50 dark:bg-dark-input dark:text-white rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-500 resize-none" rows="3" placeholder="اكتب استفسارك هنا..." value={newPost} onChange={e=>setNewPost(e.target.value)}></textarea>
                        <div className="mt-3 flex justify-end">
                            <button onClick={addPost} className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none">نشر</button>
                        </div>
                    </div>

                    <div className="space-y-4">
                        {posts.map(p => (
                            <div key={p.id} className="bg-white dark:bg-dark-card p-5 rounded-2xl border dark:border-dark-border shadow-sm">
                                <div className="flex justify-between items-start">
                                    <div className="flex gap-3">
                                        <div className="w-10 h-10 bg-slate-100 dark:bg-dark-input rounded-full flex items-center justify-center font-bold text-slate-600 dark:text-slate-300">{p.user[0]}</div>
                                        <div><h4 className="font-bold dark:text-white text-sm">{p.user}</h4><span className="text-[10px] text-slate-400">{p.ts?.toDate().toLocaleDateString('ar-EG')}</span></div>
                                    </div>
                                    {(isAdmin || p.uid === user.uid) && <button onClick={()=>delPost(p.id)} className="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" className="w-4"></i></button>}
                                </div>
                                <p className="mt-3 text-slate-700 dark:text-slate-300 leading-relaxed">{p.text}</p>
                                
                                {p.reply ? (
                                    <div className="mt-4 bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-900/30">
                                        <div className="flex items-center gap-2 mb-2 text-xs font-bold text-indigo-700 dark:text-indigo-300"><i data-lucide="corner-down-left" className="w-4"></i> رد من {p.replyBy}</div>
                                        <p className="text-sm dark:text-white">{p.reply}</p>
                                    </div>
                                ) : (
                                    isAdmin && (
                                        <div className="mt-4 flex gap-2">
                                            <input className="flex-1 p-2 rounded-lg border dark:bg-dark-input dark:border-dark-border dark:text-white text-sm" placeholder="اكتب رداً..." value={replyText[p.id]||''} onChange={e=>setReplyText({...replyText, [p.id]:e.target.value})} />
                                            <button onClick={()=>sendReply(p.id)} className="bg-slate-800 text-white p-2 rounded-lg"><i data-lucide="send" className="w-4"></i></button>
                                        </div>
                                    )
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 3. Training & Leaderboard (Full Features) ---
        const TrainingView = ({ user }) => {
            const [view, setView] = useState('list');
            const [exams, setExams] = useState([]);
            const [curr, setCurr] = useState(null);
            const [qIndex, setQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [finished, setFinished] = useState(false);
            const [showAns, setShowAns] = useState(false);
            const [selOpt, setSelOpt] = useState(null);
            const [lbData, setLbData] = useState(null); // Leaderboard
            const isAdmin = user.email === ADMIN_EMAIL;
            const { showToast, showConfirm } = useUI();

            // Create State
            const [newT, setNewT] = useState('');
            const [qs, setQs] = useState([]);
            const [qTxt, setQTxt] = useState('');
            const [qType, setQType] = useState('mcq');
            const [qOps, setQOps] = useState(['','','','']);
            const [qCor, setQCor] = useState(0);
            const [qExpl, setQExpl] = useState('');

            useEffect(() => {
                const unsub = window.fb.onSnapshot(window.fb.collection(window.fb.db, "training"), s => {
                    setExams(s.docs.map(d=>({id:d.id, ...d.data()}))); setTimeout(()=>window.lucide.createIcons(), 100);
                });
                return () => unsub();
            }, []);

            const openLB = async (e) => {
                const snap = await window.fb.getDocs(window.fb.query(window.fb.collection(window.fb.db, "training_results"), window.fb.where("examId", "==", e.id)));
                setLbData(snap.docs.map(d=>d.data()).sort((a,b)=>b.score-a.score));
            };

            const addQ = () => { if(!qTxt)return; setQs([...qs, {txt:qTxt, type:qType, ops:qType==='mcq'?qOps:[], cor:qCor, expl:qExpl}]); setQTxt(''); setQExpl(''); setQOps(['','','','']); };
            const saveEx = async () => { if(!newT || !qs.length)return; await window.fb.addDoc(window.fb.collection(window.fb.db, "training"), {title:newT, qs, views:0}); setView('list'); setQs([]); setNewT(''); showToast("تم الحفظ"); };
            const deleteEx = (id) => showConfirm("حذف النموذج؟", "لا يمكن التراجع", async()=>{await window.fb.deleteDoc(window.fb.doc(window.fb.db, "training", id)); showToast("تم الحذف","error")});

            const start = async (e) => {
                await window.fb.updateDoc(window.fb.doc(window.fb.db, "training", e.id), {views:(e.views||0)+1});
                setCurr(e); setQIndex(0); setScore(0); setFinished(false); setSelOpt(null); setShowAns(false); setView('take');
            };

            const finish = async () => {
                setFinished(true);
                await window.fb.addDoc(window.fb.collection(window.fb.db, "training_results"), { examId: curr.id, user: user.displayName||"طالب", score: score, total: curr.qs.length });
            };

            if(lbData) return (
                <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm" onClick={()=>setLbData(null)}>
                    <div className="bg-white dark:bg-dark-card w-full max-w-sm p-6 rounded-3xl shadow-2xl border dark:border-dark-border" onClick={e=>e.stopPropagation()}>
                        <h3 className="font-bold text-xl mb-4 dark:text-white flex items-center gap-2"><i data-lucide="trophy" className="text-yellow-500 w-6 h-6"></i> المتصدرين</h3>
                        <div className="space-y-3 max-h-64 overflow-y-auto custom-scrollbar">
                            {lbData.length===0?<p className="text-center text-slate-400">لا يوجد نتائج بعد</p>:lbData.map((r,i)=>(
                                <div key={i} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-dark-bg rounded-xl border dark:border-dark-border">
                                    <div className="flex items-center gap-3"><span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${i===0?'bg-yellow-400 text-white':i===1?'bg-gray-300 text-gray-700':'bg-slate-200 text-slate-600'}`}>{i+1}</span><span className="font-bold dark:text-white">{r.user}</span></div>
                                    <span className="font-mono text-indigo-600 font-bold">{r.score}/{r.total}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if(view==='list') return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold dark:text-white">التدريب</h2>{isAdmin&&<button onClick={()=>setView('create')} className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg">إضافة</button>}</div>
                    <div className="grid md:grid-cols-2 gap-4">{exams.map(e=>(
                        <div key={e.id} className="bg-white dark:bg-dark-card p-5 rounded-2xl border dark:border-dark-border shadow-sm flex flex-col justify-between hover:shadow-md transition">
                            <div className="flex justify-between items-start mb-4"><div><h3 className="font-bold text-lg dark:text-white">{e.title}</h3><p className="text-xs text-slate-500 mt-1">{e.qs.length} سؤال</p></div>{isAdmin&&<button onClick={()=>deleteEx(e.id)} className="text-red-500 opacity-50 hover:opacity-100"><i data-lucide="trash-2" className="w-4 h-4"></i></button>}</div>
                            <div className="flex justify-between items-center pt-4 border-t dark:border-dark-border">
                                <div className="flex gap-3"><div className="flex items-center gap-1 text-xs bg-slate-100 dark:bg-dark-bg px-2 py-1 rounded text-slate-600 dark:text-slate-300 font-bold"><i data-lucide="eye" className="w-3 h-3 text-indigo-500"></i> {e.views||0}</div><button onClick={()=>openLB(e)} className="flex items-center gap-1 text-xs bg-slate-100 dark:bg-dark-bg px-2 py-1 rounded text-slate-600 dark:text-slate-300 font-bold hover:bg-yellow-50 hover:text-yellow-600"><i data-lucide="trophy" className="w-3 h-3 text-yellow-500"></i> الأوائل</button></div>
                                <button onClick={()=>start(e)} className="bg-slate-900 dark:bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-1">بدء <i data-lucide="arrow-left" className="w-4 h-4"></i></button>
                            </div>
                        </div>
                    ))}</div>
                </div>
            );

            if(view==='create' && isAdmin) return (
                <div className="space-y-4 animate-fade-in">
                    <button onClick={()=>setView('list')} className="text-sm text-slate-500 flex items-center gap-1"><i data-lucide="arrow-right" className="w-4"></i> عودة</button>
                    <div className="bg-white dark:bg-dark-card p-6 rounded-2xl border dark:border-dark-border space-y-4">
                        <input className="w-full p-3 border-b dark:bg-dark-card dark:text-white font-bold outline-none" placeholder="عنوان النموذج" value={newT} onChange={e=>setNewT(e.target.value)} />
                        <div className="bg-slate-50 dark:bg-dark-bg p-4 rounded-xl space-y-3">
                            <div className="flex gap-2 mb-2"><button onClick={()=>setQType('mcq')} className={`px-3 py-1 rounded text-xs ${qType==='mcq'?'bg-indigo-600 text-white':'bg-white dark:bg-dark-card'}`}>اختيارات</button><button onClick={()=>setQType('essay')} className={`px-3 py-1 rounded text-xs ${qType==='essay'?'bg-indigo-600 text-white':'bg-white dark:bg-dark-card'}`}>مقالي</button></div>
                            <textarea className="w-full p-3 rounded-lg border dark:bg-dark-input dark:border-dark-border dark:text-white" placeholder="السؤال" value={qTxt} onChange={e=>setQTxt(e.target.value)} />
                            {qType==='mcq' && qOps.map((o,i)=><div key={i} className="flex gap-2"><input type="radio" name="c" checked={qCor===i} onChange={()=>setQCor(i)} /><input className="flex-1 p-2 rounded border dark:bg-dark-input dark:text-white" placeholder={`خيار ${i+1}`} value={o} onChange={e=>{const n=[...qOps];n[i]=e.target.value;setQOps(n)}} /></div>)}
                            <textarea className="w-full p-3 rounded-lg border dark:bg-dark-input dark:border-dark-border dark:text-white" placeholder="الشرح / الإجابة" value={qExpl} onChange={e=>setQExpl(e.target.value)} />
                            <button onClick={addQ} className="w-full bg-slate-800 text-white py-2 rounded-lg font-bold">إضافة السؤال</button>
                        </div>
                        <p className="text-xs text-slate-500">تم إضافة {qs.length} أسئلة</p>
                        <button onClick={saveEx} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold">حفظ ونشر</button>
                    </div>
                </div>
            );

            if(view==='take') {
                if(finished) return <div className="min-h-[50vh] flex flex-col items-center justify-center text-center animate-fade-in bg-white dark:bg-dark-card p-8 rounded-3xl border dark:border-dark-border shadow-xl"><div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4"><i data-lucide="award" className="w-10 h-10 text-green-600"></i></div><h2 className="text-3xl font-bold dark:text-white mb-2">النتيجة</h2><p className="text-6xl font-mono text-indigo-600 dark:text-indigo-400 font-bold mb-6">{score} <span className="text-2xl text-slate-400">/ {curr.qs.length}</span></p><button onClick={()=>setView('list')} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold">خروج</button></div>;
                const q = curr.qs[qIndex];
                return (
                    <div className="max-w-2xl mx-auto space-y-6 animate-fade-in pb-20">
                        <div className="flex justify-between items-center"><h3 className="font-bold dark:text-white">{curr.title}</h3><span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">{qIndex+1}/{curr.qs.length}</span></div>
                        <div className="w-full bg-slate-200 dark:bg-dark-border h-1.5 rounded-full overflow-hidden mb-4"><div className="bg-indigo-600 h-full transition-all duration-500" style={{width:`${((qIndex+1)/curr.qs.length)*100}%`}}></div></div>
                        <div className="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border dark:border-dark-border">
                            <h2 className="text-lg font-bold mb-6 dark:text-white leading-relaxed">{q.txt}</h2>
                            {q.type==='mcq' ? (
                                <div className="space-y-3">{q.ops.map((o,i)=><button key={i} disabled={selOpt!==null} onClick={()=>{setSelOpt(i); setShowAns(true); if(i===q.cor) setScore(s=>s+1);}} className={`w-full text-right p-4 rounded-xl border transition flex items-center gap-3 ${selOpt===null?'border-slate-200 dark:border-dark-border hover:bg-slate-50 dark:hover:bg-dark-bg dark:text-white':i===q.cor?'bg-green-50 border-green-500 text-green-700':i===selOpt?'bg-red-50 border-red-500 text-red-700':'opacity-50 dark:text-slate-500'}`}><span className="w-6 h-6 rounded-full border flex items-center justify-center text-xs">{String.fromCharCode(65+i)}</span>{o}</button>)}</div>
                            ) : (
                                <div className="space-y-4"><textarea className="w-full p-4 border rounded-xl dark:bg-dark-input dark:border-dark-border dark:text-white outline-none" rows="4" placeholder="إجابتك..."></textarea><button onClick={()=>setShowAns(!showAns)} className="text-indigo-600 text-sm font-bold underline flex items-center gap-2"><i data-lucide="eye" className="w-4"></i> الإجابة النموذجية</button></div>
                            )}
                            {showAns && q.expl && <div className="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-300 rounded-xl text-sm border border-blue-100 dark:border-blue-900"><div className="font-bold mb-1 flex items-center gap-2"><i data-lucide="info" className="w-4"></i> توضيح:</div>{q.expl}</div>}
                            <div className="mt-8 flex justify-end"><button disabled={q.type==='mcq'&&selOpt===null} onClick={()=>{if(qIndex<curr.qs.length-1){setQIndex(p=>p+1);setSelOpt(null);setShowAns(false);}else finish();}} className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold disabled:opacity-50 hover:bg-indigo-700 transition">{qIndex===curr.qs.length-1?'إنهاء':'التالي'}</button></div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        // --- 4. Dashboard (Updated Layout) ---
        const Dashboard = ({ user }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');
            const [showNameModal, setShowNameModal] = useState(false);
            const [newName, setNewName] = useState('');
            const [showBroadcast, setShowBroadcast] = useState(false);
            const [bcMsg, setBcMsg] = useState('');
            const { showToast, showConfirm } = useUI();
            const isAdmin = user.email === ADMIN_EMAIL;

            useEffect(() => { if(darkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); localStorage.setItem('theme', darkMode ? 'dark' : 'light'); }, [darkMode]);
            useEffect(() => { setTimeout(() => window.lucide.createIcons(), 50); }, [activeTab, showMobileMenu]);
            useEffect(() => { if(!user.displayName) setShowNameModal(true); }, [user]);

            const saveName = async () => { if(!newName.trim()) return; await window.fb.updateProfile(user, {displayName:sanitize(newName)}); setShowNameModal(false); showToast("أهلاً بك "+newName); };
            const sendBc = async () => { if(!bcMsg) return; await window.fb.addDoc(window.fb.collection(window.fb.db, "broadcasts"), {message:sanitize(bcMsg), timestamp: new Date()}); setShowBroadcast(false); setBcMsg(''); showToast("تم الإرسال"); };

            const NavItem = ({ id, icon, label }) => ( <button onClick={() => { setActiveTab(id); setShowMobileMenu(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === id ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-dark-muted hover:bg-slate-50 dark:hover:bg-dark-bg'}`}><i data-lucide={icon} className="w-5 h-5"></i><span>{label}</span></button> );

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-dark-bg transition-colors flex">
                    <BroadcastOverlay />
                    {showNameModal && <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 p-4"><div className="bg-white dark:bg-dark-card p-6 rounded-2xl w-full max-w-sm text-center border dark:border-dark-border"><h3 className="text-xl font-bold mb-4 dark:text-white">الاسم للعرض</h3><input className="w-full p-3 border rounded-xl mb-4 dark:bg-dark-input dark:text-white outline-none" placeholder="اسمك" value={newName} onChange={e=>setNewName(e.target.value)} /><button onClick={saveName} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">حفظ</button></div></div>}
                    {showBroadcast && <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 p-4"><div className="bg-white dark:bg-dark-card p-6 rounded-2xl w-full max-w-sm border dark:border-dark-border"><h3 className="font-bold mb-4 dark:text-white">رسالة عاجلة</h3><textarea className="w-full p-3 border rounded-xl mb-4 dark:bg-dark-input dark:text-white" rows="3" value={bcMsg} onChange={e=>setBcMsg(e.target.value)} /><div className="flex gap-2"><button onClick={sendBc} className="flex-1 bg-red-600 text-white py-2 rounded-xl font-bold">إرسال</button><button onClick={()=>setShowBroadcast(false)} className="flex-1 bg-slate-200 py-2 rounded-xl font-bold">إلغاء</button></div></div></div>}

                    <aside className="hidden md:flex flex-col w-72 bg-white dark:bg-dark-card border-l dark:border-dark-border p-6 shadow-sm z-50 sticky top-0 h-screen">
                        <div className="flex items-center gap-3 px-2 mb-10"><div className="bg-indigo-600 p-2 rounded-lg shadow-lg"><i data-lucide="graduation-cap" className="text-white w-6 h-6"></i></div><span className="font-bold text-2xl text-slate-800 dark:text-white tracking-tight">جامعتي</span></div>
                        <nav className="flex-1 space-y-2"><NavItem id="home" icon="layout-grid" label="الرئيسية" /><NavItem id="forum" icon="messages-square" label="المنتدى" /><NavItem id="training" icon="file-question" label="التدريب" /><NavItem id="exams" icon="alarm-clock" label="الامتحانات" /><NavItem id="courses" icon="book-open" label="المواد" /><NavItem id="tasks" icon="list-todo" label="المهام" /></nav>
                        <div className="pt-6 border-t dark:border-dark-border space-y-3">
                            {isAdmin && <button onClick={()=>setShowBroadcast(true)} className="w-full flex items-center gap-3 px-4 py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition"><i data-lucide="megaphone" className="w-5 h-5"></i> تحديث</button>}
                            <button onClick={()=>setDarkMode(!darkMode)} className="w-full flex items-center gap-3 px-4 py-3 bg-slate-50 dark:bg-dark-bg rounded-xl font-bold dark:text-white hover:bg-slate-100 transition"><i data-lucide={darkMode?"sun":"moon"} className="w-5 h-5"></i>{darkMode?'نهاري':'ليلي'}</button>
                            <button onClick={()=>showConfirm("تسجيل خروج؟", "هل أنت متأكد؟", ()=>window.fb.signOut(window.fb.auth))} className="w-full flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl font-bold transition"><i data-lucide="log-out" className="w-5 h-5"></i> خروج</button>
                        </div>
                    </aside>
                    <div className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="bg-white dark:bg-dark-card border-b dark:border-dark-border p-4 flex justify-between items-center z-50 sticky top-0 shadow-sm">
                            <div className="flex items-center gap-2 md:hidden"><i data-lucide="graduation-cap" className="text-indigo-600 dark:text-indigo-400 w-6 h-6"></i><span className="font-bold text-lg text-slate-800 dark:text-white">جامعتي</span></div>
                            <div className="hidden md:block font-bold text-lg dark:text-white">لوحة التحكم</div>
                            <div className="flex gap-3 items-center">
                                <NotificationBell />
                                <button onClick={()=>setDarkMode(!darkMode)} className="p-2 bg-slate-100 dark:bg-dark-bg rounded-xl md:hidden"><i data-lucide={darkMode?"sun":"moon"} className="w-5 h-5 dark:text-white"></i></button>
                                <button onClick={()=>setShowMobileMenu(!showMobileMenu)} className="p-2 bg-slate-100 dark:bg-dark-bg rounded-xl md:hidden"><i data-lucide={showMobileMenu?"x":"menu"} className="w-6 h-6 dark:text-white"></i></button>
                            </div>
                        </header>
                        {showMobileMenu && <div className="md:hidden fixed inset-0 top-[65px] bg-white dark:bg-dark-card z-40 p-4 space-y-2 animate-in slide-in-from-top-2 border-t dark:border-dark-border"><NavItem id="home" icon="layout-grid" label="الرئيسية" /><NavItem id="forum" icon="messages-square" label="المنتدى" /><NavItem id="training" icon="file-question" label="التدريب" /><NavItem id="exams" icon="alarm-clock" label="الامتحانات" /><NavItem id="courses" icon="book-open" label="المواد" /><NavItem id="tasks" icon="list-todo" label="المهام" />{isAdmin && <button onClick={()=>setShowBroadcast(true)} className="w-full flex items-center gap-3 px-4 py-3 text-red-600 font-bold mb-2"><i data-lucide="megaphone" className="w-5 h-5"></i> تحديث</button>}<div className="h-px bg-slate-100 dark:bg-dark-border my-4"></div><button onClick={()=>window.fb.signOut(window.fb.auth)} className="w-full flex items-center gap-3 px-4 py-3 text-red-500 font-bold"><i data-lucide="log-out" className="w-5 h-5"></i> خروج</button></div>}
                        <main className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar pb-20"><div className="max-w-5xl mx-auto">
                            {/* --- Insert Previous Components Here (Courses, Exams, etc. - Included implicitly via function refs) --- */}
                            {/* Note: I'm not re-pasting Exams/Courses/Tasks/Home components to save space, but they are REQUIRED here. 
                                In a real file, paste the functions: ExamsView, CoursesView, TasksView, HomeView from previous steps. 
                                I will render HomeView as default and assume others exist in scope. 
                                FOR COMPLETENESS, I will define simple placeholders for the ones not fully defined above if any. 
                                Actually, I defined Training, Forum above. I need to define the rest briefly. */}
                            
                            {/* Render Logic */}
                            {activeTab === 'home' && <HomeView user={user} setTab={setActiveTab} />}
                            {activeTab === 'forum' && <ForumView user={user} />}
                            {activeTab === 'training' && <TrainingView user={user} />}
                            {activeTab === 'exams' && <ExamsView user={user} />}
                            {activeTab === 'courses' && <CoursesView user={user} />}
                            {activeTab === 'tasks' && <TasksView user={user} />}
                        </div></main>
                    </div>
                </div>
            );
        };

        // --- Other Views (Re-implementing briefly for full copy-paste ability) ---
        const ExamsView=({user})=>{const[e,sE]=useState([]);const{showToast,showConfirm}=useUI();const[n,sN]=useState({subject:'',type:'Final',date:'',location:''});const add=async(ev)=>{ev.preventDefault();if(n.subject){await window.fb.addDoc(window.fb.collection(window.fb.db,"exams"),{uid:user.uid,...n,createdAt:new Date()});sN({subject:'',type:'Final',date:'',location:''});showToast("تم");}};const del=(id)=>showConfirm("حذف؟","",async()=>{await window.fb.deleteDoc(window.fb.doc(window.fb.db,"exams",id));showToast("حذف","error");});useEffect(()=>{return window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"exams"),window.fb.where("uid","==",user.uid)),s=>sE(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(a.date)-new Date(b.date))))},[user]);return(<div className="space-y-6 animate-fade-in"><h2 className="text-2xl font-bold dark:text-white">الامتحانات</h2><div className="bg-white dark:bg-dark-card p-5 rounded-2xl border dark:border-dark-border"><form onSubmit={add} className="grid grid-cols-2 gap-3"><input className="p-2 border rounded dark:bg-dark-input dark:text-white col-span-2" placeholder="المادة" value={n.subject} onChange={e=>sN({...n,subject:e.target.value})}/><input className="p-2 border rounded dark:bg-dark-input dark:text-white" type="datetime-local" value={n.date} onChange={e=>sN({...n,date:e.target.value})}/><input className="p-2 border rounded dark:bg-dark-input dark:text-white" placeholder="القاعة" value={n.location} onChange={e=>sN({...n,location:e.target.value})}/><button className="bg-red-600 text-white rounded font-bold col-span-2 py-2">إضافة</button></form></div><div className="grid md:grid-cols-2 gap-4">{e.map(x=><div key={x.id} className="p-4 bg-white dark:bg-dark-card border dark:border-dark-border rounded-xl shadow-sm"><div className="flex justify-between"><h3 className="font-bold dark:text-white">{x.subject}</h3><button onClick={()=>del(x.id)} className="text-red-500"><i data-lucide="trash-2" className="w-4"></i></button></div><p className="text-sm text-slate-500">{new Date(x.date).toLocaleString()}</p></div>)}</div></div>)};
        const CoursesView=({user})=>{const[c,sC]=useState([]);const{showToast,showConfirm}=useUI();const[n,sN]=useState({name:'',maxAbsence:4});const add=async(ev)=>{ev.preventDefault();if(n.name){await window.fb.addDoc(window.fb.collection(window.fb.db,"courses"),{uid:user.uid,...n,absences:0});sN({name:'',maxAbsence:4});showToast("تم");}};const up=(id,v)=>{if(v<0)return;window.fb.updateDoc(window.fb.doc(window.fb.db,"courses",id),{absences:v})};const del=(id)=>showConfirm("حذف؟","",async()=>{await window.fb.deleteDoc(window.fb.doc(window.fb.db,"courses",id));showToast("حذف","error");});useEffect(()=>{return window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"courses"),window.fb.where("uid","==",user.uid)),s=>sC(s.docs.map(d=>({id:d.id,...d.data()}))))},[user]);return(<div className="space-y-6 animate-fade-in"><h2 className="text-2xl font-bold dark:text-white">المواد</h2><div className="bg-white dark:bg-dark-card p-5 rounded-2xl border dark:border-dark-border"><form onSubmit={add} className="flex gap-2"><input className="flex-1 p-2 border rounded dark:bg-dark-input dark:text-white" placeholder="المادة" value={n.name} onChange={e=>sN({...n,name:e.target.value})}/><button className="bg-indigo-600 text-white px-4 rounded font-bold">+</button></form></div><div className="grid md:grid-cols-2 gap-4">{c.map(x=>{const d=(x.absences||0)>=x.maxAbsence;return<div key={x.id} className={`p-4 bg-white dark:bg-dark-card border rounded-xl ${d?'border-red-500 bg-red-50 dark:bg-red-900/10':'dark:border-dark-border'}`}><div className="flex justify-between"><h3 className="font-bold dark:text-white">{x.name}</h3><button onClick={()=>del(x.id)} className="text-red-500"><i data-lucide="trash-2" className="w-4"></i></button></div><div className="flex justify-between items-center mt-2"><span className="dark:text-white">الغياب: {x.absences}/{x.maxAbsence}</span><div><button onClick={()=>up(x.id,(x.absences||0)-1)} className="mx-1 px-2 border rounded bg-white dark:bg-dark-input dark:text-white">-</button><button onClick={()=>up(x.id,(x.absences||0)+1)} className="mx-1 px-2 border rounded bg-indigo-50 text-indigo-600">+</button></div></div>{d&&<p className="text-xs text-red-600 font-bold mt-1 animate-pulse">تجاوزت الحد!</p>}</div>})}</div></div>)};
        const TasksView=({user})=>{const[t,sT]=useState([]);const{showToast}=useUI();const[n,sN]=useState('');const add=async(e)=>{e.preventDefault();if(n){await window.fb.addDoc(window.fb.collection(window.fb.db,"tasks"),{uid:user.uid,title:n,completed:!1,createdAt:new Date()});sN('');showToast("تم");}};useEffect(()=>{return window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"tasks"),window.fb.where("uid","==",user.uid)),s=>sT(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>b.createdAt-a.createdAt)))},[user]);return(<div className="space-y-6 animate-fade-in"><h2 className="text-2xl font-bold dark:text-white">المهام</h2><form onSubmit={add} className="relative"><input className="w-full h-12 pl-4 pr-12 border rounded-xl dark:bg-dark-input dark:border-dark-border dark:text-white" value={n} onChange={e=>sN(e.target.value)} placeholder="مهمة جديدة..." /><button className="absolute left-2 top-2 bg-indigo-600 text-white px-4 py-1 rounded font-bold">إضافة</button></form><div className="space-y-2">{t.map(x=><div key={x.id} className={`p-3 border rounded-xl flex items-center gap-3 ${x.completed?'opacity-50 dark:bg-dark-bg':'bg-white dark:bg-dark-card dark:border-dark-border'}`}><button onClick={()=>window.fb.updateDoc(window.fb.doc(window.fb.db,"tasks",x.id),{completed:!x.completed})} className={`w-5 h-5 rounded-full border ${x.completed?'bg-green-500':''}`}></button><span className={`flex-1 ${x.completed?'line-through':''} dark:text-white`}>{x.title}</span><button onClick={()=>window.fb.deleteDoc(window.fb.doc(window.fb.db,"tasks",x.id))}><i data-lucide="trash-2" className="w-4 text-slate-300 hover:text-red-500"/></button></div>)}</div></div>)};
        const HomeView=({user,setTab})=>{const[s,sS]=useState({c:0,t:0});useEffect(()=>{window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"courses"),window.fb.where("uid","==",user.uid)),x=>sS(p=>({...p,c:x.size})));window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db,"tasks"),window.fb.where("uid","==",user.uid),window.fb.where("completed","==",!1)),x=>sS(p=>({...p,t:x.size})))},[user]);return(<div className="space-y-8 animate-fade-in"><div className="bg-indigo-600 p-8 rounded-3xl text-white shadow-xl relative overflow-hidden"><h1 className="text-3xl font-bold mb-2">مرحباً {user.displayName} 👋</h1><p className="opacity-90">يوم سعيد!</p></div><PomodoroTimer /><div className="grid md:grid-cols-2 gap-6"><div onClick={()=>setTab('courses')} className="p-6 bg-white dark:bg-dark-card border dark:border-dark-border rounded-2xl shadow-sm cursor-pointer"><h3 className="text-slate-500 font-bold">المواد</h3><span className="text-4xl font-bold dark:text-white">{s.c}</span></div><div onClick={()=>setTab('tasks')} className="p-6 bg-white dark:bg-dark-card border dark:border-dark-border rounded-2xl shadow-sm cursor-pointer"><h3 className="text-slate-500 font-bold">المهام</h3><span className="text-4xl font-bold dark:text-white">{s.t}</span></div></div></div>)};

        // --- Root ---
        const App = () => {
            const [user, setUser] = useState(null); const [ready, setReady] = useState(false);
            useEffect(() => { const init = () => { if (window.fb) { setReady(true); window.fb.onAuthStateChanged(window.fb.auth, setUser); } }; if (window.fb) init(); else window.addEventListener('firebase-ready', init); }, []);
            if(!ready) return <Loading />; 
            return <UIProvider>{user ? <Dashboard user={user} /> : <AuthScreen />}</UIProvider>;
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

